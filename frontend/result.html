<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Assessment Results</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'brand-primary': '#6366f1',
            'brand-sidebar': '#eef2ff'
          }
        }
      }
    }
  </script>

</head>

<body class="bg-gray-50 min-h-screen p-6">

<div class="max-w-7xl mx-auto">

  <h1 class="text-3xl font-bold mb-8 text-gray-800">Assessment History</h1>

  <!-- Loader -->
  <div id="loadingBox"
       class="flex h-96 items-center justify-center text-gray-400">
    Loading analysis...
  </div>

  <!-- Empty State -->
  <div id="emptyBox"
       class="hidden text-center py-20 bg-white rounded-3xl border border-gray-100 shadow-sm">

    <svg class="w-16 h-16 text-gray-200 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2"/>
    </svg>

    <p class="text-gray-500 font-medium">No results found.</p>

  </div>

  <!-- Results Container -->
  <div id="resultsContainer" class="space-y-12"></div>

</div>

<script>

/* ---------------- FETCH HISTORY ---------------- */

fetchHistory();

async function fetchHistory() {

  try {

    const res = await fetch("http://localhost:5000/history");
    const data = await res.json();

    document.getElementById("loadingBox").classList.add("hidden");

    if (!data || data.length === 0) {
      document.getElementById("emptyBox").classList.remove("hidden");
      return;
    }

    renderResults(data);

  } catch (err) {

    console.error(err);
    document.getElementById("loadingBox").innerText = "Failed to load data";

  }

}

/* ---------------- RENDER RESULTS ---------------- */

function renderResults(history) {

  const container = document.getElementById("resultsContainer");

  history.forEach((record, index) => {

    let analysisData;

    try {

      analysisData = typeof record.analysis === "object"
        ? record.analysis
        : JSON.parse(record.analysis);

    } catch {

      analysisData = {
        summary: record.analysis,
        details: [],
        metrics: {
          total: Math.min(100, Math.round((record.round1_score + record.round2_score)))
        }
      };
    }

    const distressIndex = analysisData.metrics.total || 0;
    const depression = analysisData.metrics.depression || 0;
    const anxiety = analysisData.metrics.anxiety || 0;
    const stress = analysisData.metrics.stress || 0;

    const riskBadge =
      distressIndex >= 80 ? "High Risk" :
      distressIndex >= 50 ? "Moderate Risk" :
      "Normal / Stable";

    const riskColor =
      distressIndex >= 80 ? "red" :
      distressIndex >= 50 ? "yellow" :
      "green";

    const date = new Date(record.created_at).toLocaleDateString();

    const detailsHTML = (analysisData.details || []).map(item => `
      <div class="flex items-start">
        <div class="w-6 h-6 rounded-full bg-brand-sidebar text-brand-primary flex items-center justify-center mt-1 mr-3">
          ✓
        </div>
        <p class="text-gray-600">${item}</p>
      </div>
    `).join("");

    container.innerHTML += `

    <div class="bg-white shadow-sm rounded-3xl overflow-hidden border border-gray-100">

      <!-- Header -->
      <div class="px-8 py-5 flex justify-between items-center border-b
      ${riskColor === 'red' ? 'bg-red-50' : riskColor === 'yellow' ? 'bg-yellow-50' : 'bg-green-50'}">

        <h3 class="font-bold text-gray-800 text-lg">
          Assessment Run #${history.length - index}
        </h3>

        <div class="flex items-center gap-4">

          <span class="px-4 py-1 rounded-full text-xs font-bold uppercase
          ${riskColor === 'red' ? 'bg-red-100 text-red-700' :
            riskColor === 'yellow' ? 'bg-yellow-100 text-yellow-700' :
            'bg-green-100 text-green-700'}">
            ${riskBadge}
          </span>

          <span class="text-gray-400 text-sm">${date}</span>

        </div>

      </div>

      <!-- Body -->
      <div class="p-8 grid grid-cols-1 lg:grid-cols-3 gap-12">

        <!-- Metrics -->
        <div class="border-b lg:border-b-0 lg:border-r border-gray-100 pb-8 lg:pb-0 lg:pr-8">

          <div class="text-center mb-8">

            <div class="inline-flex items-center justify-center w-36 h-36 rounded-full border-8 bg-white text-5xl font-extrabold mb-4
            ${riskColor === 'red' ? 'border-red-100 text-red-600' :
              riskColor === 'yellow' ? 'border-yellow-100 text-yellow-600' :
              'border-green-100 text-green-600'}">

              ${distressIndex}

            </div>

            <p class="text-sm font-bold text-gray-400 uppercase">Distress Index</p>

          </div>

          ${metricBar("Depression Level", depression)}
          ${metricBar("Anxiety Level", anxiety)}
          ${metricBar("Stress Level", stress)}

        </div>

        <!-- Clinical -->
        <div class="lg:col-span-2">

          <h3 class="text-xl font-bold mb-6 text-gray-900">
            Clinical Analysis & Solutions
          </h3>

          <p class="italic font-semibold mb-6 ${riskColor === 'red' ? 'text-red-600' : 'text-gray-700'}">
            "${analysisData.summary}"
          </p>

          <div class="space-y-4 mb-8">
            ${detailsHTML}
          </div>

          ${
            distressIndex >= 80 ? `
            <div class="bg-red-50 border-2 border-red-100 rounded-2xl p-6">

              <h4 class="font-bold text-red-800 mb-2">
                Action Required
              </h4>

              <p class="text-red-700 mb-4">
                Professional consultation is recommended.
              </p>

              <a href="doctors.html"
                 class="block text-center bg-red-600 text-white font-bold py-3 rounded-xl hover:bg-red-700">
                 Talk to a Doctor Now →
              </a>

            </div>
            ` : ''
          }

        </div>

      </div>

    </div>

    `;

  });

}

/* ---------------- METRIC BAR ---------------- */

function metricBar(title, value) {

  let color =
    value > 60 ? 'bg-red-400' :
    value > 30 ? 'bg-yellow-400' :
    'bg-green-400';

  return `
    <div class="mb-6">
      <div class="flex justify-between text-sm mb-2">
        <span>${title}</span>
        <span>${value}%</span>
      </div>
      <div class="w-full bg-gray-100 h-2.5 rounded-full overflow-hidden">
        <div style="width:${value}%"
             class="h-full ${color}">
        </div>
      </div>
    </div>
  `;
}

</script>

</body>
</html>
